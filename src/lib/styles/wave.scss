@use '$lib/styles/config.scss' as *;
@use 'sass:map';
@use 'sass:string';

// =============================================================================
// ğŸ¨ æ ¸å¿ƒå‡½æ•°ï¼šURL ç¼–ç 
// =============================================================================
/// URL ç¼–ç å‡½æ•° - å¤„ç† SVG ä¸­çš„ç‰¹æ®Šå­—ç¬¦
/// @param {String} $string - éœ€è¦ç¼–ç çš„å­—ç¬¦ä¸²
/// @return {String} - ç¼–ç åçš„å­—ç¬¦ä¸²
@function url-encode($string) {
	$map: (
		'%': '%25',
		'<': '%3C',
		'>': '%3E',
		' ': '%20',
		'!': '%21',
		'*': '%2A',
		"'": '%27',
		'"': '%22',
		'(': '%28',
		')': '%29',
		';': '%3B',
		':': '%3A',
		'@': '%40',
		'&': '%26',
		'=': '%3D',
		'+': '%2B',
		'$': '%24',
		',': '%2C',
		'/': '%2F',
		'?': '%3F',
		'#': '%23',
		'[': '%5B',
		']': '%5D'
	);

	$result: $string;
	@each $search, $replace in $map {
		$result: str-replace($result, $search, $replace);
	}
	@return $result;
}

/// å­—ç¬¦ä¸²æ›¿æ¢è¾…åŠ©å‡½æ•°
/// @param {String} $string - åŸå­—ç¬¦ä¸²
/// @param {String} $search - è¦æœç´¢çš„å­—ç¬¦ä¸²
/// @param {String} $replace - æ›¿æ¢çš„å­—ç¬¦ä¸²
/// @return {String} - æ›¿æ¢åçš„å­—ç¬¦ä¸²
@function str-replace($string, $search, $replace: '') {
	$index: string.index($string, $search);

	@if $index {
		@return string.slice($string, 1, $index - 1) + $replace +
			str-replace(string.slice($string, $index + string.length($search)), $search, $replace);
	}

	@return $string;
}

// =============================================================================
// ğŸ¯ æ ¸å¿ƒå‡½æ•°ï¼šç”Ÿæˆ SVG Data URI
// =============================================================================

/// ç”Ÿæˆæ³¢æµª SVG Data URI
/// @param {Color} $stroke - æè¾¹é¢œè‰²
/// @param {Number} $opacity - é€æ˜åº¦ (0-1)
/// @param {String} $stroke-width - æè¾¹å®½åº¦ (å¯é€‰)
/// @return {String} - å®Œæ•´çš„ Data URI
@function generate-wave-svg($stroke, $opacity: 1, $stroke-width: null) {
	$width: map.get($wave-config, 'width');
	$height: map.get($wave-config, 'height');
	$viewBox: map.get($wave-config, 'viewBox');
	$path: map.get($wave-config, 'path');
	$default-stroke-width: map.get($wave-config, 'stroke-width');

	// ä½¿ç”¨ä¼ å…¥çš„ stroke-width æˆ–é»˜è®¤å€¼
	$final-stroke-width: if($stroke-width, $stroke-width, $default-stroke-width);

	// æ„å»º SVG å­—ç¬¦ä¸²
	$svg: '<svg width="#{$width}" height="#{$height}" viewBox="#{$viewBox}" xmlns="http://www.w3.org/2000/svg">';
	$svg: $svg +
		'<path d="#{$path}" stroke="#{$stroke}" stroke-width="#{$final-stroke-width}" fill="none"';

	// æ·»åŠ é€æ˜åº¦ï¼ˆå¦‚æœä¸æ˜¯ 1ï¼‰
	@if $opacity != 1 {
		$svg: $svg + ' opacity="#{$opacity}"';
	}

	$svg: $svg + '/></svg>';

	// URL ç¼–ç å¹¶è¿”å›å®Œæ•´çš„ Data URI
	@return 'url("data:image/svg+xml;utf8,#{url-encode($svg)}")';
}

// =============================================================================
// ğŸ¨ ä¸»é¢˜ç›¸å…³å‡½æ•°
// =============================================================================

/// è·å–ä¸»é¢˜é¢œè‰²
/// @param {String} $theme - ä¸»é¢˜åç§°
/// @param {String} $state - çŠ¶æ€ (normal/hover)
/// @param {String} $property - å±æ€§ (normal/normal-opacity/hover/hover-opacity/bg-hover)
/// @return {*} - å¯¹åº”çš„å€¼
@function get-theme-value($theme, $property) {
	$themes: map.get($wave-config, 'themes');
	$theme-config: map.get($themes, $theme);
	@return map.get($theme-config, $property);
}

/// ç”Ÿæˆä¸»é¢˜çš„ SVG Data URI
/// @param {String} $theme - ä¸»é¢˜åç§°
/// @param {String} $state - çŠ¶æ€ (normal/hover)
/// @return {String} - SVG Data URI
@function get-theme-svg($theme, $state) {
	@if $state == 'normal' {
		$color: get-theme-value($theme, 'normal');
		$opacity: get-theme-value($theme, 'normal-opacity');
		@return generate-wave-svg($color, $opacity);
	} @else if $state == 'hover' {
		$color: get-theme-value($theme, 'hover');
		$opacity: get-theme-value($theme, 'hover-opacity');
		@return generate-wave-svg($color, $opacity);
	}
}

// =============================================================================
// ğŸ§© Mixinï¼šæ³¢æµªä¸‹åˆ’çº¿ç”Ÿæˆå™¨
// =============================================================================

/// æ ¸å¿ƒ Mixinï¼šç”Ÿæˆæ³¢æµªä¸‹åˆ’çº¿æ ·å¼
/// @param {String} $theme - ä¸»é¢˜åç§° (light/dark/custom)
/// @param {Map} $custom-config - è‡ªå®šä¹‰é…ç½® (å¯é€‰)
@mixin underline($theme, $custom-config: ()) {
	// åˆå¹¶è‡ªå®šä¹‰é…ç½®
	$config: map.merge($wave-config, $custom-config);

	// è®¡ç®—å°ºå¯¸
	$scale: map.get($config, 'scale');
	$width: map.get($config, 'width') * $scale * 1em;
	$height: map.get($config, 'height') * $scale * 1em;
	$vertical-offset: map.get($config, 'vertical-offset');
	$animation-duration: map.get($config, 'animation-duration');
	$animation-timing: map.get($config, 'animation-timing');
	$transition-duration: map.get($config, 'transition-duration');

	// åŸºç¡€æ ·å¼
	text-decoration: none;
	background-repeat: repeat-x;
	background-size: $width $height;
	background-position: 0 100%;
	padding-bottom: #{$height * $vertical-offset};
	background-color: transparent;
	transition: background-image $transition-duration ease;

	// åŠ¨ç”»ï¼ˆé»˜è®¤æš‚åœï¼‰
	animation: wave-move $animation-duration $animation-timing infinite paused;

	// è®¾ç½®é»˜è®¤ SVG
	background-image: #{get-theme-svg($theme, 'normal')};

	// Hover çŠ¶æ€
	&:hover {
		background-image: #{get-theme-svg($theme, 'hover')};
		background-color: #{get-theme-value($theme, 'bg-hover')};
		animation-play-state: running;
	}

	// ç”ŸæˆåŠ¨ç”»å…³é”®å¸§ï¼ˆé¿å…é‡å¤å®šä¹‰ï¼‰
	@at-root {
		@keyframes wave-move {
			0% {
				background-position-x: 0;
			}
			100% {
				background-position-x: #{-$width};
			}
		}
	}
}

@mixin auto-theme(
	$theme-map: (
		'': 'light',
		'[data-mode="dark"]': 'dark'
	)
) {
	@each $selector, $theme in $theme-map {
		@if $selector == '' {
			@include underline($theme);
		} @else {
			#{$selector} & {
				@include underline($theme);
			}
		}
	}
}
